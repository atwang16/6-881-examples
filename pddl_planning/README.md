# PDDL Planning

This module contains classes and examples for using [PDDL](http://users.cecs.anu.edu.au/~patrik/pddlman/writing.html) and [PDDLStream](https://github.com/caelan/pddlstream/tree/master) for task and motion planning of the KUKA IIWA arm.

Most of this code was written by [Caelan Garrett](https://github.com/caelan).

## Files

- `run.py` constructs and solves the PDDLStream planning problem of opening the left cabinet door and placing the object on a shelf.
- `domain.pddl` specifies the predicates and actions present within the PDDLStream problem. Its syntax is identical to the standard PDDL domain-file syntax.
- `stream.pddl` contains a declarative specification of the streams used. Its syntax is inspired by PDDL syntax.
- `generators.py` contains the Python implementation for the streams declared within `domain.pddl`.
- `problem.py` contains the `Task` class which manages the Drake system, encodes the initial problem state, and describes the problem goal conditions.
- `motion.py` contains procedures for performing sampling-based motion planning within Drake.
- `simulation.py` contains methods for (1) displaying position trajectories by stepping through each position in the trajectory, (2) converting a sequence of position trajectories into a sequence of splines and gripper setpoints, and (3) simulating the system using `plan_runner/manipulation_station_plan_runner.py`.
- `systems.py` builds the `ManipulationStation` system `Diagram`.
- `iiwa_utils.py` contains several KUKA IIWA specific utilities for opening and closing the Schunk gripper and generating grasp transformations for boxes.
- `utils.py` contains general-purpose Drake Python utilities.
- `poses.txt` contains text representation of `Isometry3` poses of objects on the table found by DOPE.
- `test_pddl_planning.py` is a script to test basic functionality of this module for continuous integration.
- The `models/` is a git submodule containing useful `.sdf` model files, including those of the YCB Objects recognized by DOPE.

## Using This Module
`run.py` takes in a few command line arguments to run through the complete task and motion planning problem.

- `-c`/`--cfree` disables collision checking when planning.
- `-d`/`--deterministic` manually sets the first random seed used by the stream generators. Note that this does not make the whole planning process deterministic.
- `-e`/`--execute` runs the system on the physical manipulation station.
- `-f`/`--force_control` uses an impedance controller to open the door instead of plans generated by PDDL.
- `-l`/`--load` uses the last plan. It must be used with `-s` or `-e`.
- `-s`/`--simulate` simulates the system using a `plan_runner/ManipulationStationSimulator`.

### Examples
Make sure to start a meschat server in a separate terminator window or in the background before running the following examples.

Generate a new trajectory using force control and simulate it:

```sh
$ python run.py -f -s
```

Simulate the system using the last plan:

```sh
$ python run.py -l -s
```

Generate a new plan ignoring collisions:

```sh
$ python run.py -c
```

Generate a new plan and run it on the real robot:

```sh
$ python run.py -e
```
